#!/usr/bin/env bash

process_file() {
	if ! is_python_file "$1"; then
		[[ -n "$PRE_COMMIT_DEBUG" ]] && printf "check_python skipped %s\n" "$1"
		return 0
	fi

	# formatters
	if ! command -v add-trailing-comma >/dev/null 2>&1; then
		printf "ERROR: add-trailing-comma missing\n"
		return 1
	fi
	if add-trailing-comma "$1" --py36-plus; then
		git add "$1"
	else
		printf "ERROR: add-trailing-comma failed on %s\n" "$1"
		return 1
	fi
	if ! command -v black >/dev/null 2>&1; then
		printf "ERROR: black missing\n"
		return 1
	fi
	if black "$1" --quiet; then
		git add "$1"
	else
		printf "ERROR: black failed on %s\n" "$1"
		return 1
	fi

	# linters
	if ! command -v flake8 >/dev/null 2>&1; then
		printf "ERROR: flake8 missing\n"
		return 1
	fi
	if ! flake8 "$1"; then
		printf "ERROR: flake8 failed on %s\n" "$1"
		return 1
	fi
	return 0
}

is_python_file() {
	if [[ -f "$1" ]] && [[ "$1" == *.py ]]; then
		return 0
	else
		return 1
	fi
}

process_file "$1"
exit $?
