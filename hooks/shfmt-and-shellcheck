#!/usr/bin/env bash

needs_run() {
	if [[ "$1" == *.bash ]]; then
		return 0
	fi
	line=$(head -n 1 "$1")
	if [[ "$line" == *bash* ]]; then
		return 0
	else
		return 1
	fi
}

run_hook() {
	debug=$PRE_COMMIT_DEBUG
	strict=$PRE_COMMIT_STRICT

	if ! needs_run "$1"; then
		[[ -n "$debug" ]] && printf "Skipping shfmt/shellcheck %s\n" "$1"
		return 0
	fi
	echo $strict

	if command -v shfmt >/dev/null 2>&1; then
		[[ -n "$debug" ]] && printf "Running shfmt %s\n" "$1"
		if ! shfmt -w "$1"; then
			[[ -n "$debug" ]] && printf "Failing shfmt %s\n" "$1"
			return 1
		fi
		git add "$1"
		[[ -n "$debug" ]] && printf "Running shellcheck %s\n" "$1"
		if shellcheck "$1"; then
			return 0
		else
			[[ -n "$debug" ]] && printf "Failing shellcheck %s\n" "$1"
			return 1
		fi
	else
		if [[ -n "$strict" ]]; then
			printf "shfmt not found\n"
		fi

	fi
}

if run_hook "$1"; then
	exit 0
else
	exit 1
fi
