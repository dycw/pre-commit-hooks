#!/usr/bin/env bash
# shellcheck source=/dev/null

run_all_hooks() {
	staged_names=$(git diff --name-only --cached)
	if [ -z "$staged_names" ]; then
		return 0
	fi

	root=$(git rev-parse --show-toplevel)

	declare -a files
	while read -r staged_name; do
		staged_path="$root/$staged_name"
		if [ -f "$staged_path" ]; then
			files+=("$staged_path")
		elif [ -d "$staged_path" ]; then
			while read -r name_in_dir; do
				files+=("$root/$name_in_dir")
			done <<<"$(git ls-files "$root"/"$staged_path")"
		fi
	done <<<"$staged_names"

	hooks="$root"
	if [ -d "$root/.pre-commit-hooks" ]; then
		hooks="$root/.pre-commit-hooks" # deployment
	fi
	hooks="$hooks/hooks"

	code=0
	while read -r hook; do
		if ! "$hook" "${files[@]}"; then
			code=1
		fi
	done <<<"$(find "$hooks" -type f)"

	if [ -n "$(git diff --name-only --cached)" ]; then
		return $code
	else
		return 0
	fi
}

run_all_hooks
exit $?
