#!/usr/bin/env bash
# shellcheck source=/dev/null

run_hooks_on_all_files() {
	if [ -z "$(git diff --name-only --cached)" ]; then
		return 0
	fi

	root=$(git rev-parse --show-toplevel)
	code=0
	while read -r staged_file; do
		staged_path="$root/$staged_file"
		if [ -f "$staged_path" ]; then
			if ! run_hooks_on_file "$staged_path"; then
				code=1
			fi
		elif [ -d "$staged_path" ]; then
			while read -r file_in_dir; do
				if ! run_hooks_on_file "$root/$file_in_dir"; then
					code=1
				fi
			done <<<"$(git ls-files "$root/$staged_path
")"
		fi
	done <<<"$(git diff --name-only --cached)"

	if [ -n "$(git diff --name-only --cached)" ]; then
		return $code
	else
		return 0
	fi
}

run_hooks_on_file() {
	root=$(git rev-parse --show-toplevel)
	if [ -d "$root/.pre-commit-hooks" ]; then
		path="$root/.pre-commit-hooks" # deployment
	else
		path="$root" # development
	fi
	code=0
	while read -r hook; do
		if ! "$hook" "$1"; then
			code=1
		fi
	done <<<"$(find "$path/hooks" -type f)"
	return $code
}

if run_hooks_on_all_files; then
	exit 0
else
	exit 1
fi
